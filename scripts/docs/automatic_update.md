# 自动更新脚本

## 功能概述

`automatic_update.bat` 是实现应用自更新功能的核心脚本，支持安全更新和回滚机制。

## 主要特性

### 🔄 安全更新流程
- 服务停止和删除
- 进程终止和文件替换
- 备份和回滚机制
- 详细的日志记录

### 🛡️ 错误处理
- 参数完整性检查
- 管理员权限验证
- 文件存在性验证
- 重试和超时机制

### 📊 日志系统
- 时间戳日志文件
- 详细的调试信息
- 错误和警告记录
- 操作状态跟踪

## 使用方法

### 参数格式
```bash
automatic_update.bat <service_name> <new_exe_path> <old_exe_path> <backup_dir>
```

### 参数说明
- `service_name`: Windows服务名称（可选）
- `new_exe_path`: 新版本exe文件路径
- `old_exe_path`: 旧版本exe文件路径
- `backup_dir`: 备份文件目录

## 更新流程

### 1. 参数验证
- 检查参数完整性
- 验证管理员权限
- 记录参数信息

### 2. 服务处理
- 检查服务存在性
- 停止运行的服务
- 删除服务注册

### 3. 进程终止
- 查找相关进程
- 强制终止进程
- 等待进程完全退出

### 4. 文件替换
- 备份文件验证
- 文件复制操作
- 文件大小验证
- 重试机制

### 5. 新进程启动
- 启动新版本应用
- 错误代码检查
- 回滚机制触发

### 6. 回滚机制
- 备份文件查找
- 文件恢复操作
- 旧版本启动
- 错误报告

## 错误处理

### 常见错误代码
- **216**: 新进程启动失败
- **其他**: 文件操作错误

### 回滚条件
- 新文件不存在
- 文件复制失败
- 新进程启动失败
- 备份文件缺失

## 日志文件

### 日志位置
- 自动生成时间戳日志文件
- 格式: `update_YYYYMMDD_HHMM.log`

### 日志内容
- 操作时间戳
- 参数信息
- 执行步骤
- 错误详情
- 调试信息

## 安全考虑

### 权限要求
- 需要管理员权限
- 文件系统访问权限
- 服务管理权限

### 数据安全
- 备份文件保护
- 文件完整性验证
- 操作原子性保证