# Local Agent 本地代理服务项目

## 🎯 项目概述

Local Agent 是一个基于Python开发的本地代理服务应用，提供设备管理、远程控制、自动更新等核心功能，以Windows服务形式运行，**已实现生产环境就绪的完整解决方案**。

## 🚀 快速开始

### 唯一正确的启动方式

根据项目规则，唯一正确的启动方式为：

```bash
# 1. 打包应用（开发阶段）
python scripts/pyinstaller_packager.py

# 2. 以管理员身份运行打包后的exe（生产环境）
右键管理员运行 dist/local_agent.exe
```

**重要说明**：打包后的exe文件已内置完整的双进程保活机制，无需使用其他启动脚本。

### 开发环境运行

1. **安装依赖**
```bash
pip install -r requirements.txt
```

2. **启动服务**
```bash
python -m src.local_agent
```

3. **访问API**
```bash
curl http://localhost:8001/health
```

## 📚 项目结构

```
f:\testPc\dragTest/
├── src/local_agent/          # 源代码目录
│   ├── api/                  # API接口模块（FastAPI服务）
│   ├── auto_update/          # 自动更新模块
│   ├── core/                 # 核心功能模块（应用主类、双进程保活等）
│   ├── ui/                   # 用户界面模块（消息对话框、系统托盘）
│   ├── utils/                # 工具类模块（文件操作、网络通信等）
│   ├── websocket/            # WebSocket客户端模块（实时通信）
│   ├── docs/                 # 项目总体文档
│   ├── config.py             # 配置文件
│   └── logger.py             # 日志配置（支持日志副本功能）
├── scripts/                  # 脚本目录
│   ├── docs/                 # 脚本功能文档
│   ├── pyinstaller_packager.py # PyInstaller打包脚本
│   ├── automatic_update.bat  # 自动更新批处理
│   └── service_management/   # 服务管理脚本
├── hooks/                    # PyInstaller钩子脚本
│   └── docs/                 # 钩子脚本文档
├── tests/                    # 测试目录
├── requirements.txt          # 依赖包列表
└── VERSION                   # 全局版本号定义
```

## ✅ 核心功能

### 🏗️ 功能模块
- **FastAPI服务器**: 提供RESTful API接口（EK结果汇报、DMR信息上报等）
- **WebSocket客户端**: 支持实时双向通信（单例模式管理）
- **自动更新**: 支持在线版本检查和自动更新（MD5校验、备份机制）
- **Windows服务**: 通过NSSM注册为系统服务
- **双进程保活**: 两个进程互相监控，确保高可用性
- **系统托盘**: 后台运行时提供操作入口和状态显示

### 🔧 工具支持
- **文件操作**: 安全的文件读写和目录管理
- **版本管理**: 版本号解析和比较
- **子进程管理**: 增强的子进程执行工具（支持管理员权限）
- **HTTP客户端**: 封装网络请求功能
- **MD5校验**: 文件完整性验证（大文件分块计算）
- **定时器工具**: 线程安全定时任务管理

### ✨ 新增功能特性
- **按钮超时功能**: 消息对话框支持按钮倒计时和自动触发
- **日志副本功能**: 可随时开启/关闭的额外日志记录
- **VNC服务管理**: VNC连接状态检测和服务管理
- **系统托盘API**: 用户名获取和代理更新功能

## 📚 完整文档体系

项目已建立完整的文档体系，所有文档均使用中文编写：

### 📖 模块文档
- **项目总体文档**: `src/local_agent/docs/` - 项目总体功能说明
- **API接口文档**: `src/local_agent/api/docs/` - API模块详细说明
- **自更新文档**: `src/local_agent/auto_update/docs/` - 自动更新功能说明
- **核心功能文档**: `src/local_agent/core/docs/` - 核心模块详细说明
- **用户界面文档**: `src/local_agent/ui/docs/` - UI模块功能说明
- **工具函数文档**: `src/local_agent/utils/docs/` - 工具模块详细说明
- **WebSocket文档**: `src/local_agent/websocket/docs/` - 通信模块功能说明

### 🔧 支持文档
- **脚本功能文档**: `scripts/docs/` - 脚本目录功能说明
- **钩子脚本文档**: `hooks/docs/` - PyInstaller钩子脚本说明

## 🛡️ 生产环境特性

### 🔥 高可靠性保活机制

#### 双进程互监控保活
- **双进程守护**：两个进程互相监控，任一进程异常退出时自动重启
- **智能重启策略**：限制每小时最大重启次数，防止无限重启循环
- **更新协调**：在自动更新期间暂停保活机制，避免冲突
- **进程状态监控**：实时监控进程状态、内存使用和CPU占用

#### 多层级健康检查
- **进程级监控**：监控进程存活状态和资源使用情况
- **服务级健康检查**：定期检查API服务和WebSocket连接状态
- **资源优化**：自动清理临时文件，优化内存使用
- **错误恢复**：智能识别异常状态并自动恢复

### 💤 防睡眠与唤醒保持

#### Windows原生防睡眠
- **系统唤醒锁**：使用Windows原生API保持系统唤醒状态
- **显示器控制**：可选保持显示器亮起或仅保持系统运行
- **离开模式支持**：支持媒体播放等场景的离开模式
- **心跳检测**：每5分钟检测一次唤醒状态，确保持续有效

#### 智能电源管理
- **自动恢复**：系统休眠唤醒后自动恢复服务状态
- **资源保护**：防止因系统休眠导致的服务中断
- **配置灵活**：可根据场景需求调整防睡眠策略

### 🔒 安全与权限控制
- ✅ 服务账户权限控制：使用最小权限原则运行服务
- ✅ 安全的文件操作：所有文件操作都进行权限验证
- ✅ 日志文件权限管理：确保日志文件的安全访问
- ✅ 网络通信加密：支持HTTPS和WSS安全通信

### 🛠️ 可维护性与监控
- ✅ 完整的日志系统：结构化日志记录，支持日志轮转
- ✅ 模块化架构设计：各功能模块独立，便于维护和扩展
- ✅ 自动更新机制：支持在线版本检查和一键更新
- ✅ 版本升级支持：平滑升级，保持配置和数据完整性
- ✅ 性能监控：实时监控系统资源使用和服务性能指标

---

**项目状态**: ✅ 生产环境就绪  
**最后更新**: 2025-01-13  
**版本**: 1.0.0