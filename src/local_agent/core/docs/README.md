# Core 核心模块功能说明

## 模块概述
核心模块是整个应用的基础架构，负责应用生命周期管理、进程保活、鉴权认证、全局缓存等核心功能。

## 📋 文件功能说明

### `__init__.py` - 模块初始化文件
- **功能**: 模块包初始化定义
- **作用**:
  - 定义模块的公共接口和导出类
  - 提供模块级别的导入控制
  - 声明 `LocalAgentApplication` 类为模块的主要导出对象

### `application.py` - 应用主类
- **功能**: 应用生命周期管理和主流程控制
- **核心组件**:
  - **LocalAgentApplication类**: 应用主类，管理整个应用的生命周期
  - **组件初始化**: API服务器、WebSocket客户端、自更新管理器等
  - **信号处理**: 优雅关闭和重启机制
  - **任务管理**: 异步任务调度和监控
- **主要特性**:
  - 完整的应用启动、运行、停止流程
  - 支持debug模式和正常模式
  - 与各模块的协同工作

### `dual_process_guardian.py` - 双进程互监控保活
- **功能**: 实现双进程互相监控的保活机制
- **核心组件**:
  - **DualProcessGuardian类**: 双进程互监控守护类
  - **进程管理**: 进程启动、监控、重启
  - **健康检查**: 定期健康状态检查
  - **更新协调**: 更新过程中的进程协调
- **主要特性**:
  - 两个进程互相监控，确保高可用性
  - 自动重启异常进程
  - 防止进程死锁和资源泄漏

### `auth.py` - 鉴权认证模块
- **功能**: 处理用户鉴权和token管理
- **核心组件**:
  - **auth_token()**: 获取鉴权token
  - **refresh_token()**: 刷新鉴权token
- **主要特性**:
  - 基于HTTP请求的鉴权流程
  - token自动刷新机制
  - 与全局缓存集成

### `constants.py` - 常量定义
- **功能**: 定义项目中使用的常量
- **包含常量**:
  - 缓存键常量: AUTHORIZATION_CACHE_KEY, AUTH_INFO_CACHE_KEY等
  - 时间相关常量: AGENT_UPDATE_FAILED_TIME等
  - 路径相关常量: PYTHON_CACHE_KEY等
  - VNC相关常量: REALVNC_CACHE_KEY等

### `global_cache.py` - 全局缓存管理
- **功能**: 提供跨模块数据共享的全局缓存
- **核心组件**:
  - **GlobalCache类**: 线程安全的全局缓存实现
  - **LRU淘汰策略**: 自动清理最久未使用的缓存
  - **TTL支持**: 支持缓存项过期时间设置
- **主要特性**:
  - 线程安全的数据访问
  - 自动过期清理
  - 支持字典类型值的部分更新

### `dmr.py` - 设备管理相关
- **功能**: 设备管理和注册功能
- **作用**: 处理设备相关的管理操作

### `ek.py` - EK相关功能
- **功能**: EK（设备密钥）相关操作
- **作用**: 处理设备密钥的生成和管理

### `heartbeat_manager.py` - 心跳管理
- **功能**: 心跳检测和连接状态管理
- **作用**: 维持与服务器的连接状态

### `host_init.py` - 主机初始化
- **功能**: 主机环境初始化和配置
- **作用**: 应用启动时的环境准备

### `persistent_storage.py` - 持久化存储
- **功能**: 数据持久化存储管理
- **作用**: 提供数据长期保存能力

### `process_guardian.py` - 进程守护
- **功能**: 单进程守护和监控
- **作用**: 确保单个进程的稳定运行

### `tray_api.py` - 系统托盘API
- **功能**: 系统托盘相关接口管理
- **作用**: 提供用户名获取、代理更新等系统托盘功能
- **主要接口**:
  - `get_username()`: 获取当前用户名
  - `agent_update()`: 代理更新功能

### `vnc.py` - VNC服务管理
- **功能**: VNC服务状态检测和管理
- **作用**: 处理VNC连接状态检测和服务管理
- **核心组件**:
  - **VNC类**: VNC服务管理类
  - **VncInfo模型**: VNC连接信息数据模型
  - **VncRes模型**: VNC服务状态结果模型

### `wake_lock.py` - 唤醒锁管理
- **功能**: 防止系统进入睡眠模式
- **作用**: 保持应用运行期间系统唤醒状态

## 🔗 模块间关系
- **application** 作为核心控制器，协调其他所有模块
- **dual_process_guardian** 提供高可用性保障
- **global_cache** 为各模块提供数据共享能力
- **auth** 处理安全认证相关功能
- **tray_api** 提供系统托盘交互能力
- **vnc** 管理VNC远程连接服务

## 技术特点
- 基于异步编程模型，提高并发性能
- 完整的错误处理和恢复机制
- 模块化设计，便于扩展和维护
- 线程安全的数据访问控制