# WebSocket 通信模块功能说明

## 模块概述
WebSocket模块负责处理与服务器的实时双向通信，提供连接管理、消息处理、状态同步等核心功能，确保应用与服务器之间的实时数据交换。

## 📋 文件功能说明

### `__init__.py` - 模块初始化文件
- **功能**: 模块包初始化定义
- **作用**: 定义模块的公共接口和导出类
- **导出**: 主要导出WebSocket管理器和客户端类

### `client.py` - WebSocket客户端
- **功能**: WebSocket客户端连接实现
- **作用**: 建立和维护与服务器的WebSocket连接
- **特性**: 支持连接状态管理、消息发送接收、自动重连
- **核心类**: `WebSocketClient` - WebSocket客户端主类

### `global_websocket_manager.py` - 全局WebSocket管理器
- **功能**: 全局WebSocket连接管理
- **作用**: 管理多个WebSocket连接的全局状态
- **特性**: 提供统一的连接管理接口，支持多连接协调
- **核心类**: `GlobalWebSocketManager` - 全局WebSocket管理器

### `message_handler.py` - 消息处理器
- **功能**: WebSocket消息处理逻辑
- **作用**: 处理接收到的WebSocket消息，执行相应的业务逻辑
- **特性**: 支持消息路由、错误处理、消息验证
- **关键函数**: `register_websocket_handlers()`, `get_message_handler()`

### `message_manager.py` - 消息管理器
- **功能**: 消息队列和调度管理
- **作用**: 管理待发送的消息队列，控制消息发送顺序和频率
- **特性**: 支持消息优先级、批量发送、流量控制
- **关键函数**: `get_message_manager()` - 获取消息管理器实例

### `message_sender.py` - 消息发送器
- **功能**: 消息发送功能实现
- **作用**: 负责将消息发送到WebSocket连接
- **特性**: 支持异步发送、发送状态跟踪、错误重试
- **关键函数**: `get_message_sender()` - 获取消息发送器实例

### `websocket_manager.py` - WebSocket管理器
- **功能**: WebSocket连接生命周期管理
- **作用**: 管理WebSocket连接的创建、维护和关闭
- **特性**: 支持连接状态监控、心跳检测、异常处理
- **核心类**: `WebSocketManager` - WebSocket管理器主类（单例模式）

## 🏗️ 架构设计

### 核心组件关系
```
WebSocket管理器 (websocket_manager.py) - 单例模式，全局管理
    ↓
全局管理器 (global_websocket_manager.py) - 多连接协调
    ↓
客户端 (client.py) → 消息发送器 (message_sender.py)
    ↓
消息处理器 (message_handler.py) ← 消息管理器 (message_manager.py)
```

### 消息流处理
1. **消息接收**: 客户端接收服务器消息
2. **消息路由**: 消息处理器根据消息类型分发
3. **业务处理**: 执行相应的业务逻辑
4. **响应发送**: 通过消息发送器返回响应

## 🔗 模块间关系

### 与核心模块的关系
- **application模块**: WebSocket管理器由应用主类初始化和控制
- **heartbeat_manager模块**: 依赖WebSocket进行心跳检测和状态同步
- **global_cache模块**: 使用全局缓存存储连接状态和消息数据
- **config模块**: 读取WebSocket连接配置参数

### 与工具模块的关系
- **timer_utils模块**: 用于心跳定时器和重连定时器
- **http_client模块**: 在WebSocket连接失败时作为备选通信方式
- **logger模块**: 记录WebSocket连接和消息日志

## 🎯 使用场景

### 实时数据同步
- 设备状态实时更新
- 配置变更即时推送
- 任务执行进度同步

### 双向通信
- 服务器指令下发
- 客户端状态上报
- 实时消息交互

### 连接状态管理
- 自动重连机制
- 连接健康检查
- 网络异常处理

## 🛠️ 技术特点

### 连接管理
- **自动重连**: 网络异常时自动重新建立连接
- **心跳检测**: 定期发送心跳包维持连接活性
- **状态监控**: 实时监控连接状态和网络质量
- **单例模式**: WebSocket管理器采用单例模式确保全局唯一

### 消息处理
- **异步处理**: 支持高并发消息处理
- **错误恢复**: 消息发送失败时自动重试
- **流量控制**: 防止消息洪泛，保证系统稳定性
- **延迟导入**: 避免循环依赖问题

### 性能优化
- **连接池管理**: 优化连接资源使用
- **消息压缩**: 减少网络传输数据量
- **批量发送**: 提高消息发送效率

## ⚡ 关键功能点

### 连接生命周期管理
- 连接的创建、维护和关闭
- 连接状态跟踪和异常处理
- 自动重连和故障转移
- 单例模式确保全局唯一管理

### 消息可靠性保证
- 消息确认机制
- 发送失败重试
- 消息顺序保证
- 延迟导入避免循环依赖

### 系统集成
- 与主应用的无缝集成
- 支持多线程环境
- 提供统一的API接口
- 与配置系统和日志系统紧密集成

## 🔄 工作流程

### 启动流程
1. 应用启动时初始化WebSocket管理器
2. 读取配置参数建立连接
3. 注册消息处理器
4. 启动心跳检测

### 消息处理流程
1. 接收服务器消息
2. 消息处理器路由到对应业务逻辑
3. 执行业务处理
4. 通过消息发送器返回响应

### 异常处理流程
1. 检测连接异常
2. 自动尝试重连
3. 记录错误日志
4. 通知上层应用