# Local Agent 项目总体功能说明

## 项目概述
Local Agent 是一个本地代理服务应用，负责设备管理、远程控制、自动更新等核心功能，以Windows服务形式运行，提供完整的本地代理解决方案。

## 📁 项目结构概览

```
src/local_agent/
├── api/              # API接口模块
├── auto_update/      # 自更新模块
├── core/            # 核心功能模块
├── ui/              # 用户界面模块
├── utils/           # 工具函数模块
├── websocket/       # WebSocket通信模块
├── __init__.py      # 包初始化文件
├── __main__.py      # 应用入口文件
├── config.py        # 配置管理
└── logger.py        # 日志系统
```

## 📋 模块功能说明

### 🔌 API接口模块 (`api/`)
- **功能**: 提供RESTful API接口服务
- **核心组件**:
  - `server.py`: FastAPI服务器管理
  - `routes.py`: API路由定义
- **主要接口**: EK结果汇报、DMR信息上报等

### 🔄 自更新模块 (`auto_update/`)
- **功能**: 应用自动更新管理
- **核心组件**: `auto_updater.py` - 自更新管理器
- **更新流程**: 版本检查 → 文件下载 → 完整性校验 → 备份创建 → 更新执行

### 🏗️ 核心功能模块 (`core/`)
- **功能**: 应用基础架构和核心业务逻辑
- **核心组件**:
  - `application.py`: 应用主类，生命周期管理
  - `dual_process_guardian.py`: 双进程互监控保活
  - `global_cache.py`: 全局缓存管理
  - `auth.py`: 鉴权认证
  - `tray_api.py`: 系统托盘API
  - `vnc.py`: VNC服务管理

### 💻 用户界面模块 (`ui/`)
- **功能**: 提供用户交互界面
- **核心组件**:
  - `message_api.py`: 消息API接口
  - `message_window.py`: 消息窗口实现（支持按钮超时）
  - `system_tray.py`: 系统托盘管理

### 🛠️ 工具函数模块 (`utils/`)
- **功能**: 通用工具函数和辅助类
- **核心组件**:
  - `message_tool.py`: 消息工具（支持按钮超时）
  - `file_downloader.py`: 文件下载器
  - `verify_md5.py`: MD5校验工具
  - `timer_utils.py`: 定时器工具
  - `subprocess_utils.py`: 子进程工具

### 🌐 WebSocket通信模块 (`websocket/`)
- **功能**: 实时双向通信管理
- **核心组件**:
  - `websocket_manager.py`: WebSocket管理器（单例模式）
  - `client.py`: WebSocket客户端
  - `message_handler.py`: 消息处理器

## 🚀 应用启动方式

根据项目规则，唯一正确的启动方式为：

```bash
# 1. 打包应用（开发阶段）
python scripts/pyinstaller_packager.py

# 2. 以管理员身份运行打包后的exe（生产环境）
右键管理员运行 dist/local_agent.exe
```

## 🔧 核心配置文件

### `config.py` - 配置管理
- **功能**: 应用配置参数管理
- **作用**: 统一管理所有配置参数，支持环境变量覆盖
- **配置项**: 服务器地址、端口号、超时设置、日志级别等

### `logger.py` - 日志系统
- **功能**: 统一日志记录和管理
- **作用**: 提供分级日志记录，支持日志副本功能
- **特性**: 线程安全、日志轮转、日志级别控制

## 🎯 主要功能特性

### 高可用性设计
- **双进程互监控**: 两个进程互相监控，确保服务高可用
- **自动重连机制**: 网络异常时自动重新建立连接
- **心跳检测**: 定期检测服务状态，确保服务活性

### 安全性保障
- **鉴权认证**: 支持token认证和自动刷新
- **文件完整性校验**: MD5校验确保文件安全
- **管理员权限**: 关键操作需要管理员权限

### 用户体验优化
- **系统托盘**: 后台运行时提供系统托盘操作入口
- **消息对话框**: 支持多种消息类型和按钮超时功能
- **自动更新**: 支持静默更新和用户确认更新

### 技术架构特点
- **模块化设计**: 各功能模块独立，便于维护和扩展
- **异步处理**: 支持高并发异步操作
- **跨平台兼容**: 基于Python实现，支持多平台运行

## 🔗 模块协作关系

### 核心控制流
```
应用启动 (__main__.py)
    ↓
应用主类 (core/application.py)
    ↓
模块初始化 (API、WebSocket、自更新等)
    ↓
服务运行 (Windows服务模式)
```

### 数据流处理
1. **外部请求**: 通过API接口接收外部请求
2. **业务处理**: 核心模块处理业务逻辑
3. **实时通信**: WebSocket模块处理实时数据交换
4. **用户交互**: UI模块提供用户反馈和操作界面

## 📊 部署和运行

### 开发环境
- 使用Python 3.8+运行源码
- 通过脚本打包生成可执行文件

### 生产环境
- 以Windows服务形式运行
- 不占用控制台窗口
- 支持后台静默运行

### 服务管理
- 支持服务安装、启动、停止、卸载
- 提供系统托盘操作入口
- 支持自动更新和手动更新

## 🔄 更新和维护

### 自动更新机制
- 支持版本检查和自动下载
- 文件完整性验证
- 备份和回滚机制

### 日志管理
- 分级日志记录
- 日志文件轮转
- 日志副本功能（可随时开启/关闭）

## ⚡ 性能优化

### 资源管理
- 连接池管理优化资源使用
- 内存泄漏检测和预防
- 线程安全的数据访问

### 网络优化
- 消息压缩减少传输数据量
- 批量发送提高效率
- 流量控制防止洪泛攻击

## 🎨 用户交互特性

### 消息对话框
- 支持确认、警告、错误等多种消息类型
- 按钮超时功能（confirm_timeout、cancel_timeout）
- 实时倒计时显示

### 系统托盘
- 提供快捷操作菜单
- 状态通知和气泡提示
- 与主应用状态同步

## 🔒 安全特性

### 数据安全
- 敏感数据加密存储
- 通信数据加密传输
- 文件完整性保护

### 访问控制
- 权限验证和授权
- 操作审计和日志记录
- 异常行为检测