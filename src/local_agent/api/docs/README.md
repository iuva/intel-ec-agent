# API 模块功能说明

## 模块概述

API模块负责提供RESTful API接口服务，基于FastAPI框架构建，支持异步处理和自动文档生成。

## 📋 文件功能说明

### `server.py` - API服务器管理

#### 🔧 主要功能
- **服务器配置**: FastAPI应用创建和配置
- **CORS支持**: 跨域资源共享中间件
- **请求日志**: API访问日志记录
- **健康检查**: 系统状态监控接口
- **端口管理**: 端口占用检查和冲突处理

#### 🏗️ 核心组件
- `APIServer`类: API服务器管理器
- `create_app()`: 创建FastAPI应用实例
- `start()`: 启动API服务器
- 支持调试模式和热重载

#### ⚙️ 配置特性
- 自动读取应用配置
- 支持多worker模式
- 优雅关闭机制
- 与双进程保活机制兼容

### `routes.py` - API路由定义

#### 🔌 主要功能
- **路由注册**: 定义所有API端点
- **数据验证**: 使用Pydantic模型验证请求数据
- **错误处理**: 统一的异常处理机制
- **业务逻辑**: 实现具体的API功能

#### 📊 当前接口
- **POST /ek/start/result**: EK启动结果汇报接口
- **POST /ek/test/result**: EK测试结果汇报接口  
- **GET /ek/log/last**: 获取最新日志接口
- **POST /dmr/info/result**: DMR信息结果汇报接口

#### 🧩 数据模型
- `EKResultEvent`: EK结果事件模型
- `CommonResponse`: 通用响应模型
- `DMRResultPayload`: DMR结果数据模型
- 支持结构化数据验证

### `__init__.py` - 模块初始化
- **功能**: 模块包初始化文件
- **作用**: 定义API模块的导入结构
- **包含**: 导出主要类和函数供外部使用

#### 📦 功能说明
- **模块导出**: 定义模块的公共接口
- **包结构**: 标识为Python包
- **导入管理**: 控制模块间的导入关系

## 🌐 API接口详情

### 健康检查接口
- **路径**: `/health`
- **方法**: GET
- **功能**: 系统状态监控
- **返回**: 系统信息、内存使用、CPU负载等

### EK结果汇报接口
- **路径**: `/api/v1/tool/result`
- **方法**: POST
- **功能**: 工具执行结果上报
- **参数**: 工具名称、测试用例ID、执行状态等

## 🔄 与其他模块的交互

### 依赖关系
```
API模块
├── config.py (配置管理)
├── logger.py (日志系统)
├── utils/http_client.py (HTTP客户端)
└── 核心应用模块 (业务逻辑)
```

### 数据流
1. **请求接收**: FastAPI接收HTTP请求
2. **数据验证**: Pydantic模型验证数据格式
3. **业务处理**: 调用相关模块处理业务逻辑
4. **响应返回**: 返回标准化响应数据

## 🛠️ 开发规范

### 接口设计原则
- RESTful风格设计
- 统一的响应格式
- 详细的错误信息
- 自动文档生成

### 代码规范
- 使用异步处理
- 统一的日志记录
- 完善的异常处理
- 模块化设计

## 📚 API文档

### 自动文档
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

### 接口测试
- 支持在线测试
- 请求示例生成
- 响应格式预览

## ⚠️ 注意事项

### 端口冲突
- API服务器会自动检查端口占用
- 与双进程保活机制兼容
- 避免多个实例同时运行

### 性能优化
- 支持多worker模式
- 异步处理提高并发能力
- 连接池和超时配置